<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>High-Risk Asymmetric DCA — Nov/Dec/Jan Backtest + Feb Draft</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --text:#e8eef6;
      --muted:#aab8c6;
      --accent:#57c7ff;
      --danger:#ff6b6b;
      --ok:#67e8a9;
      --border:rgba(255,255,255,.09);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(87,199,255,.14), transparent 55%),
                  radial-gradient(900px 500px at 90% 25%, rgba(103,232,169,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}
    header{
      display:flex; flex-wrap:wrap; gap:14px; align-items:flex-end; justify-content:space-between;
      margin-bottom:16px;
    }
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; margin-top:4px; max-width:92ch}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .card .bd{padding:16px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .hr{height:1px; background:var(--border); margin:14px 0}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background: rgba(87,199,255,.10);
      border:1px solid rgba(87,199,255,.25);
      color:var(--text); font-size:12px;
      white-space:nowrap;
    }
    .pill .dot{width:8px; height:8px; border-radius:99px; background:var(--accent)}
    .warn{ background: rgba(255,107,107,.10); border:1px solid rgba(255,107,107,.25); }
    .warn .dot{background:var(--danger)}
    .ok{ background: rgba(103,232,169,.10); border:1px solid rgba(103,232,169,.22); }
    .ok .dot{background:var(--ok)}

    .badge{
      font-family:var(--mono);
      font-size:12px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      white-space:nowrap;
    }

    .slider{
      margin-top:8px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    input[type="range"]{width:100%}

    table{width:100%; border-collapse:collapse}
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-size:13px;
      vertical-align:top;
    }
    th{color:var(--muted); font-weight:600}

    select, button{
      font-family:inherit;
    }
    select{
      background: rgba(0,0,0,.22);
      border:1px solid var(--border);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      outline:none;
    }

    .tokenBtn{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      cursor:pointer;
      color:var(--text);
      text-align:left;
    }
    .tokenBtn:hover{border-color:rgba(87,199,255,.35)}
    .alloc{
      font-family:var(--mono);
      font-size:12px;
      color:var(--text);
      opacity:.95;
      white-space:nowrap;
    }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi .box{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .val{font-family:var(--mono); font-size:14px; margin-top:6px}

    .btn{
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1000;
    }
    .modal{
      width:min(900px, 96vw);
      max-height: 92vh;
      overflow:hidden;
      border-radius: 18px;
      border:1px solid var(--border);
      background: #0f1620; /* opaque */
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .modalTitle{margin:0; font-size:16px}
    .modalBody{
      padding:16px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(92vh - 58px);
    }
    .links{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;
    }
    .linkBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      font-size:12px;
      color:var(--text);
    }
    .linkBtn:hover{border-color:rgba(87,199,255,.35); text-decoration:none}

    .sectionTitle{font-size:13px; color:var(--muted); margin:18px 0 8px}
    ul{margin:10px 0 0 18px}
    li{margin:6px 0; color:var(--text); opacity:.95}
    .footnote{color:var(--muted); font-size:12px; margin-top:14px}

    .statusLine{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      color: var(--muted); font-size:12px;
    }
    .good{color: var(--ok)}
    .bad{color: var(--danger)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>High-Risk Asymmetric DCA — Backtest + Monthly Tracker</h1>
        <div class="sub">
          Choose a strategy month (Nov 2025 / Dec 2025 / Jan 2026 / Feb 2026 draft), set your monthly buy amount, and the page will
          (1) show the token breakdown for that month, and (2) backtest your ROI if you started buying on the 1st of Nov/Dec/Jan.
          Prices are pulled client-side from CoinGecko and cached locally.
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="pill warn" title="Not financial advice. Speculative, high volatility."><span class="dot"></span>High risk</div>
        <div class="pill ok" title="Built for monthly DCA checkpoints."><span class="dot"></span>DCA</div>
        <div class="badge mono" id="todayBadge">Today: —</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="hd">
          <div class="pill warn"><span class="dot"></span>Important disclaimer</div>
          <div class="statusLine" id="apiStatus">API: idle</div>
        </div>
        <div class="bd">
          <div class="small muted">
            Not investment advice. Crypto can go to zero. Liquidity can vanish. You are responsible for your own decisions.
            This page is a planning + backtest tool using public market data; it does not execute trades.
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <div class="muted small">Strategy month</div>
              <select id="monthSelect"></select>
            </div>
            <div class="badge" id="weightsBadge">Weights sum: —</div>
          </div>

          <div class="hr"></div>

          <div class="card" style="box-shadow:none; border-color:var(--border); background: rgba(0,0,0,.16);">
            <div class="bd">
              <div class="row">
                <div>
                  <div class="muted small">Monthly buy-in total</div>
                  <div class="mono" style="font-size:20px;" id="monthlyLabel">$10,000</div>
                </div>
                <div class="badge">Buys assumed on the 1st</div>
              </div>

              <div class="slider">
                <input id="monthlySlider" type="range" min="1000" max="25000" step="250" value="10000" />
                <div class="row small muted" style="margin-top:8px;">
                  <span>$1,000</span><span>$25,000</span>
                </div>
              </div>

              <div class="kpi">
                <div class="box">
                  <div class="label">Selected month deploy</div>
                  <div class="val" id="selDeploy">$10,000</div>
                </div>
                <div class="box">
                  <div class="label">STRX portion</div>
                  <div class="val" id="strxDeploy">$3,000</div>
                </div>
              </div>

              <div class="footnote">
                Backtest assumes: buy each token at the closest available market price to the 1st of the month, hold to today.
                Contributions occur only for months whose buy date is <= today.
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="pill"><span class="dot"></span>Backtest results</div>
            <button class="btn" id="refreshBtn">Refresh prices</button>
          </div>

          <div class="small muted" style="margin-top:6px;">
            Results update with the slider. Uses CoinGecko chart-range data; cached locally to avoid rate limits.
          </div>

          <div class="hr"></div>

          <table>
            <thead>
              <tr>
                <th style="width:170px;">Start month</th>
                <th>Contributions</th>
                <th>Value today</th>
                <th>ROI</th>
              </tr>
            </thead>
            <tbody id="backtestBody">
              <tr><td colspan="4" class="muted small">Loading…</td></tr>
            </tbody>
          </table>

          <div class="footnote">
            If CoinGecko rate limits you, wait a minute and refresh, or just rely on the cache. Public plan rate limits vary. 
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <div class="hd">
          <div class="pill"><span class="dot"></span>Token breakdown</div>
          <div class="badge mono" id="monthBadge">—</div>
        </div>
        <div class="bd">
          <div class="small muted" id="monthIntro">
            Click a token to open its thesis and external links.
          </div>
          <div class="hr"></div>
          <div id="tokenList" style="display:grid; gap:10px;"></div>
          <div class="hr"></div>
          <div class="small muted">
            External links: metrics (CoinGecko), largest CEX (Binance preferred; otherwise a major exchange), and largest DEX for that token.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modalHeader">
        <div>
          <h2 class="modalTitle" id="modalTitle">Token</h2>
          <div class="small muted" id="modalSubtitle"></div>
          <div class="links" id="modalLinks"></div>
        </div>
        <button class="btn" id="modalClose">Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

<script>
/**
 * DATA MODEL
 * - Strategies are monthly portfolios with weights.
 * - Each token uses CoinGecko "coin id" for pricing.
 * - Backtest uses CoinGecko /coins/{id}/market_chart/range endpoint (client-side).
 *
 * CoinGecko docs: /coins/{id}/market_chart/range gives price series in unix range.
 * Public API has rate limits; we cache results per coin+range in localStorage.
 */

const STRATEGIES = [
  {
    key: "2025-11-01",
    label: "November 2025",
    note: "Backtest month",
    tokens: [
      {id:"strike-x", symbol:"STRX", name:"StrikeX", w:30, sector:"Adoption bridge / high-beta",
        links:{
          metrics:"https://www.coingecko.com/en/coins/strike-x",
          cex:"https://www.mexc.com/en-GB/price/STRX",
          dex:"https://pancakeswap.finance/swap?outputCurrency=0xd6fdde76b8c1c45b33790cc8751d5b88984c44ec"
        },
        thesis:`<p><strong>Thesis:</strong> High-beta asymmetric bet on StrikeX winning meaningful adoption as connective rails.</p>
        <ul><li>Win: product + usage + liquidity deepen.</li><li>Fail: execution delays, token capture weak, liquidity thin.</li></ul>`
      },
      {id:"chainlink", symbol:"LINK", name:"Chainlink", w:10, sector:"Oracles / settlement plumbing",
        links:{ metrics:"https://www.coingecko.com/en/coins/chainlink", cex:"https://www.binance.com/en/trade/LINK_USDT", dex:"https://app.uniswap.org/" },
        thesis:`<p><strong>Thesis:</strong> Oracle + middleware toll-road if TradFi/RWA expands on-chain.</p>`
      },
      {id:"ondo-finance", symbol:"ONDO", name:"Ondo", w:10, sector:"RWA yield rails",
        links:{ metrics:"https://www.coingecko.com/en/coins/ondo-finance", cex:"https://www.binance.com/en/trade/ONDO_USDT", dex:"https://app.uniswap.org/" },
        thesis:`<p><strong>Thesis:</strong> Direct expression of the RWA/tokenised finance adoption theme.</p>`
      },
      {id:"celestia", symbol:"TIA", name:"Celestia", w:8, sector:"Modular DA",
        links:{ metrics:"https://www.coingecko.com/en/coins/celestia", cex:"https://www.binance.com/en/trade/TIA_USDT", dex:"https://app.osmosis.zone/" },
        thesis:`<p><strong>Thesis:</strong> DA layer winner option if modular/appchain proliferation continues.</p>`
      },
      {id:"akash-network", symbol:"AKT", name:"Akash", w:8, sector:"DePIN compute",
        links:{ metrics:"https://www.coingecko.com/en/coins/akash-network", cex:"https://www.coinbase.com/price/akash-network", dex:"https://app.osmosis.zone/" },
        thesis:`<p><strong>Thesis:</strong> Compute marketplace option if real workloads migrate.</p>`
      },
      {id:"render-token", symbol:"RENDER", name:"Render", w:8, sector:"GPU demand / networks",
        links:{ metrics:"https://www.coingecko.com/en/coins/render-token", cex:"https://www.binance.com/en/trade/RENDER_USDT", dex:"https://app.uniswap.org/" },
        thesis:`<p><strong>Thesis:</strong> GPU-demand narrative + network utilisation optionality.</p>`
      },
      {id:"arweave", symbol:"AR", name:"Arweave", w:6, sector:"Permanent storage",
        links:{ metrics:"https://www.coingecko.com/en/coins/arweave", cex:"https://www.binance.com/en/price/arweave", dex:"https://app.uniswap.org/" },
        thesis:`<p><strong>Thesis:</strong> Permanent storage primitive re-rates if demand rises.</p>`
      },
      {id:"thorchain", symbol:"RUNE", name:"THORChain", w:6, sector:"Cross-chain liquidity",
        links:{ metrics:"https://www.coingecko.com/en/coins/thorchain", cex:"https://www.binance.com/en/trade/RUNE_USDT", dex:"https://app.thorswap.finance/" },
        thesis:`<p><strong>Thesis:</strong> Cross-chain swapping rail if volume persists.</p>`
      },
      {id:"axelar", symbol:"AXL", name:"Axelar", w:7, sector:"Interop messaging",
        links:{ metrics:"https://www.coingecko.com/en/coins/axelar", cex:"https://www.binance.com/en/trade/AXL_USDT", dex:"https://app.uniswap.org/" },
        thesis:`<p><strong>Thesis:</strong> Interop rail winner option; beware winner-takes-most dynamics.</p>`
      },
      {id:"aleph-zero", symbol:"AZERO", name:"Aleph Zero", w:7, sector:"L1 ecosystem option",
        links:{ metrics:"https://www.coingecko.com/en/coins/aleph-zero", cex:"https://www.mexc.com/exchange/AZERO_USDT", dex:"https://andromedaswap.org/" },
        thesis:`<p><strong>Thesis:</strong> Long-vol L1 ecosystem; needs real traction to earn size.</p>`
      }
    ]
  },
  {
    key: "2025-12-01",
    label: "December 2025",
    note: "Backtest month",
    tokens: [] // will default to Nov if empty (same basket)
  },
  {
    key: "2026-01-01",
    label: "January 2026",
    note: "Your current tracker month",
    tokens: [] // will default to Nov if empty (same basket)
  },
  {
    key: "2026-02-01",
    label: "February 2026 (draft)",
    note: "Draft rebalance: tilt slightly toward rails; trim tails",
    tokens: [
      // Feb draft: modest tilt (you can edit)
      // Keep same universe, adjust weights: +LINK +ONDO, small trims from AZERO/AXL/AR.
      {ref:"strike-x", w:30},
      {ref:"chainlink", w:12},
      {ref:"ondo-finance", w:12},
      {ref:"celestia", w:8},
      {ref:"akash-network", w:8},
      {ref:"render-token", w:8},
      {ref:"arweave", w:5},
      {ref:"thorchain", w:6},
      {ref:"axelar", w:5},
      {ref:"aleph-zero", w:6},
    ]
  }
];

// ---- utilities ----
const $ = (id)=>document.getElementById(id);
const fmtUSD = (n)=> n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:2});
const fmtUSD0 = (n)=> n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
const pct = (x)=> (x*100).toFixed(1)+"%";

function parseISO(s){ return new Date(s+"T00:00:00Z"); }
function toUnixSec(dt){ return Math.floor(dt.getTime()/1000); }
function dayISO(dt){
  // YYYY-MM-DD in UTC
  const y=dt.getUTCFullYear();
  const m=String(dt.getUTCMonth()+1).padStart(2,"0");
  const d=String(dt.getUTCDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}

function nearestPrice(prices, targetUnixMs){
  // prices = [[ms, price], ...]
  if(!prices || prices.length===0) return null;
  let lo=0, hi=prices.length-1;
  // binary search for closest
  while(lo<hi){
    const mid = Math.floor((lo+hi)/2);
    if(prices[mid][0] < targetUnixMs) lo = mid+1;
    else hi = mid;
  }
  const i = lo;
  const a = prices[i];
  const b = prices[i-1];
  if(!b) return a[1];
  if(!a) return b[1];
  return (Math.abs(a[0]-targetUnixMs) < Math.abs(b[0]-targetUnixMs)) ? a[1] : b[1];
}

function strategyTokensResolved(strategy){
  // If strategy.tokens empty: fallback to Nov basket
  const base = STRATEGIES[0].tokens;
  if(strategy.tokens && strategy.tokens.length>0){
    // Feb draft uses ref objects; map from base
    if(strategy.tokens[0].ref){
      return strategy.tokens.map(x=>{
        const t = base.find(b=>b.id===x.ref);
        return {...t, w:x.w};
      });
    }
    return strategy.tokens;
  }
  // default: same as base basket
  return base.map(x=>({...x}));
}

function weightsSum(tokens){
  return tokens.reduce((a,t)=>a+(t.w||0),0);
}

// ---- CoinGecko fetch with caching ----
const CG_BASE = "https://api.coingecko.com/api/v3";

function cacheKey(id, fromSec, toSec){
  return `cg_range_${id}_${fromSec}_${toSec}`;
}
function getCache(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function setCache(key, obj){
  try{ localStorage.setItem(key, JSON.stringify(obj)); }catch{}
}

async function fetchMarketChartRange(id, fromSec, toSec){
  const key = cacheKey(id, fromSec, toSec);
  const cached = getCache(key);
  if(cached && cached.prices && Array.isArray(cached.prices)) return cached;

  const url = `${CG_BASE}/coins/${encodeURIComponent(id)}/market_chart/range?vs_currency=usd&from=${fromSec}&to=${toSec}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`CoinGecko error ${res.status} for ${id}`);
  const data = await res.json();
  // store minimal
  const minimal = {prices: data.prices || []};
  setCache(key, minimal);
  return minimal;
}

// ---- Backtest computation ----
function buildBuySchedule(todayUtc){
  // Buys occur on 1st of Nov/Dec/Jan/Feb (Feb only if today >= Feb 1)
  const buys = [
    parseISO("2025-11-01"),
    parseISO("2025-12-01"),
    parseISO("2026-01-01"),
    parseISO("2026-02-01"),
  ].filter(d=> d.getTime() <= todayUtc.getTime());
  return buys;
}

async function computeBacktestForStart(startISO, monthlyAmount, strategy){
  const today = new Date();
  // normalize today to UTC midnight for valuation
  const todayUtc = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
  const start = parseISO(startISO);
  const buys = buildBuySchedule(todayUtc).filter(d=> d.getTime() >= start.getTime());

  const tokens = strategyTokensResolved(strategy);
  const fromSec = toUnixSec(parseISO("2025-11-01")) - 60; // small buffer
  const toSec = toUnixSec(todayUtc) + 60;

  // fetch ranges for all token ids (one call per token)
  const status = $("apiStatus");
  status.textContent = "API: fetching price ranges…";
  status.className = "statusLine";

  const charts = {};
  for(let i=0;i<tokens.length;i++){
    const t = tokens[i];
    try{
      charts[t.id] = await fetchMarketChartRange(t.id, fromSec, toSec);
      status.innerHTML = `API: fetched <span class="good">${i+1}/${tokens.length}</span> tokens (cached where possible)`;
    }catch(e){
      status.innerHTML = `API: <span class="bad">error</span> on ${t.symbol} (${e.message})`;
      throw e;
    }
  }

  // compute units per token purchased over buys
  const holdings = {}; // id -> units
  let contributed = 0;

  for(const buyDate of buys){
    const buyMs = buyDate.getTime();
    contributed += monthlyAmount;

    for(const t of tokens){
      const alloc = monthlyAmount * (t.w/100);
      const prices = charts[t.id].prices;
      const px = nearestPrice(prices, buyMs);
      if(!px || px<=0) continue;
      const units = alloc / px;
      holdings[t.id] = (holdings[t.id] || 0) + units;
    }
  }

  // value today
  let value = 0;
  const todayMs = todayUtc.getTime();
  for(const t of tokens){
    const units = holdings[t.id] || 0;
    if(units<=0) continue;
    const pxNow = nearestPrice(charts[t.id].prices, todayMs);
    if(!pxNow || pxNow<=0) continue;
    value += units * pxNow;
  }

  const roi = contributed>0 ? (value / contributed - 1) : 0;
  return {contributed, value, roi, buysCount: buys.length};
}

// ---- UI rendering ----
function renderMonthSelect(){
  const sel = $("monthSelect");
  sel.innerHTML = "";
  STRATEGIES.forEach((s, idx)=>{
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = s.label;
    sel.appendChild(opt);
  });
  sel.value = "2"; // default: January 2026
}

function renderTokenList(strategyIdx, monthlyAmount){
  const s = STRATEGIES[strategyIdx];
  const tokens = strategyTokensResolved(s);
  $("monthBadge").textContent = s.label;

  // weights sum
  const sum = weightsSum(tokens);
  $("weightsBadge").textContent = `Weights sum: ${sum.toFixed(0)}%`;
  $("weightsBadge").style.color = (Math.round(sum)===100) ? "var(--ok)" : "var(--danger)";

  // STRX portion KPI
  const strx = tokens.find(t=>t.symbol==="STRX");
  const strxAmt = strx ? monthlyAmount*(strx.w/100) : 0;
  $("strxDeploy").textContent = fmtUSD0(strxAmt);

  $("tokenList").innerHTML = "";
  tokens.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "tokenBtn";
    btn.type = "button";
    const amt = monthlyAmount*(t.w/100);
    btn.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:2px;">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <strong>${t.symbol}</strong>
          <span class="badge">${t.w}%</span>
        </div>
        <div class="small muted">${t.name} • ${t.sector}</div>
      </div>
      <div class="alloc">${fmtUSD0(amt)}</div>
    `;
    btn.addEventListener("click", ()=>openModal(t, amt, STRATEGIES[strategyIdx].label));
    $("tokenList").appendChild(btn);
  });

  $("selDeploy").textContent = fmtUSD0(monthlyAmount);
}

function renderBacktestRows(rows){
  const body = $("backtestBody");
  body.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    const roiClass = r.roi >= 0 ? "good" : "bad";
    tr.innerHTML = `
      <td><strong>${r.startLabel}</strong><div class="small muted">Buys: ${r.buysCount}</div></td>
      <td class="mono">${fmtUSD0(r.contributed)}</td>
      <td class="mono">${fmtUSD0(r.value)}</td>
      <td class="${roiClass} mono">${pct(r.roi)}</td>
    `;
    body.appendChild(tr);
  });
}

function setTodayBadge(){
  const today = new Date();
  const todayUtc = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
  $("todayBadge").textContent = `Today: ${dayISO(todayUtc)}`;
}

// ---- Modal ----
const overlay = $("modalOverlay");
$("modalClose").addEventListener("click", closeModal);
overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeModal(); });
window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

function openModal(token, amount, monthLabel){
  $("modalTitle").textContent = `${token.symbol} — ${token.name}`;
  $("modalSubtitle").innerHTML = `<span class="badge">${monthLabel}</span> <span class="muted small">Monthly buy: <span class="mono">${fmtUSD0(amount)}</span></span>`;

  const links = $("modalLinks");
  links.innerHTML = "";
  const defs = [
    {label:"Metrics (CoinGecko)", url: token.links?.metrics},
    {label:"Largest CEX", url: token.links?.cex},
    {label:"Largest DEX", url: token.links?.dex},
  ].filter(x=>!!x.url);

  defs.forEach(d=>{
    const a = document.createElement("a");
    a.className = "linkBtn";
    a.href = d.url;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.textContent = d.label;
    links.appendChild(a);
  });

  // richer body
  const body = token.thesis || `<p><strong>Thesis:</strong> (Add thesis for this token.)</p>`;
  $("modalBody").innerHTML = `
    ${body}
    <div class="sectionTitle">Tracking focus</div>
    <ul>
      <li><strong>Adoption:</strong> usage/TVL/volume/fees appropriate to the sector.</li>
      <li><strong>Distribution:</strong> integrations, listings, and liquidity depth.</li>
      <li><strong>Value capture:</strong> does success actually accrue to the token.</li>
    </ul>
  `;

  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}

function closeModal(){
  overlay.style.display = "none";
  overlay.setAttribute("aria-hidden","true");
  document.body.style.overflow = "";
}

// ---- Main update loop ----
async function updateAll(forceRefresh=false){
  const monthly = Number($("monthlySlider").value);
  $("monthlyLabel").textContent = fmtUSD0(monthly);

  const idx = Number($("monthSelect").value);
  const strategy = STRATEGIES[idx];

  // optionally clear cache for forced refresh
  if(forceRefresh){
    try{
      const keys = Object.keys(localStorage);
      keys.forEach(k=>{ if(k.startsWith("cg_range_")) localStorage.removeItem(k); });
      $("apiStatus").innerHTML = `API: cache cleared, refetching…`;
    }catch{}
  }

  renderTokenList(idx, monthly);

  // backtest "started in Nov / Dec / Jan"
  const startCases = [
    {iso:"2025-11-01", label:"Start Nov 2025"},
    {iso:"2025-12-01", label:"Start Dec 2025"},
    {iso:"2026-01-01", label:"Start Jan 2026"},
  ];

  try{
    const results = [];
    for(const c of startCases){
      const r = await computeBacktestForStart(c.iso, monthly, strategy);
      results.push({startLabel:c.label, ...r});
    }
    renderBacktestRows(results);
    $("apiStatus").innerHTML = `API: <span class="good">ok</span> (cached where possible)`;
  }catch(e){
    renderBacktestRows([{startLabel:"—", contributed:0, value:0, roi:0, buysCount:0}]);
    $("apiStatus").innerHTML = `API: <span class="bad">error</span> (rate limit or token id issue). Try again later.`;
  }
}

function init(){
  setTodayBadge();
  renderMonthSelect();

  // Fill Dec/Jan token baskets by copying Nov base if empty
  const base = STRATEGIES[0].tokens;
  for(const s of STRATEGIES){
    if(!s.tokens || s.tokens.length===0){
      if(s.key !== "2026-02-01"){
        s.tokens = base.map(x=>({...x}));
      }
    }
  }

  // show weights sum in badge for current selection
  $("monthSelect").addEventListener("change", ()=>updateAll(false));
  $("monthlySlider").addEventListener("input", ()=>updateAll(false));
  $("refreshBtn").addEventListener("click", ()=>updateAll(true));

  updateAll(false);
}

init();
</script>
</body>
</html>
